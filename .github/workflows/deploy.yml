name: üöÄ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  validate-secrets:
    name: üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.check-secrets.outputs.valid }}
    
    steps:
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
        id: check-secrets
        run: |
          REQUIRED_SECRETS=(
            "FIREBASE_API_KEY"
            "FIREBASE_AUTH_DOMAIN" 
            "FIREBASE_DATABASE_URL"
            "FIREBASE_PROJECT_ID"
            "FIREBASE_STORAGE_BUCKET"
            "FIREBASE_MESSAGING_SENDER_ID"
            "FIREBASE_APP_ID"
            "FIREBASE_MEASUREMENT_ID"
          )
          
          valid=true
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${{ secrets[secret] }}" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ä–µ—Ç: $secret"
              valid=false
            else
              echo "‚úÖ –°–µ–∫—Ä–µ—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $secret"
            fi
          done
          
          echo "valid=$valid" >> $GITHUB_OUTPUT
          
          if [ "$valid" = false ]; then
            exit 1
          fi

  generate-config:
    name: üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.secrets_valid == 'true'
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: üîß –ì–ï–ù–ï–†–ê–¶–ò–Ø firebase-config.js –ò–ó –®–ê–ë–õ–û–ù–ê
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üöÄ –ì–µ–Ω–µ—Ä–∏—Ä—É—é firebase-config.js..."
          node scripts/generate-config.js
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          if [ ! -f "firebase-config.js" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: firebase-config.js –Ω–µ —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
          if grep -q "{{" firebase-config.js; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –í —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã!"
            exit 1
          fi
          
          echo "‚úÖ firebase-config.js —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
          head -n 20 firebase-config.js

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
    runs-on: ubuntu-latest
    needs: generate-config
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: üîß –†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø firebase-config.js (–¥–ª—è Pages)
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üîÑ –†–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è Pages..."
          node scripts/generate-config.js
          echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é"
          
      - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll —Ñ–∞–π–ª–∞
        run: touch .nojekyll
          
      - name: üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
        uses: actions/configure-pages@v3
        
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
          
      - name: üöÄ –î–ï–ü–õ–û–ô –ù–ê GITHUB PAGES
        id: deployment
        uses: actions/deploy-pages@v2
        
      - name: ‚úÖ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –£–°–ü–ï–•–ê
        run: |
          echo "=========================================="
          echo "üéâ –£–°–ü–ï–®–ù–´–ô –î–ï–ü–õ–û–ô!"
          echo "=========================================="
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
          echo "   https://askhat707.github.io/trading-data/"
          echo ""
          echo "üìä Firebase –ø—Ä–æ–µ–∫—Ç:"
          echo "   ${{ secrets.FIREBASE_PROJECT_ID }}"
          echo ""
          echo "üîê –í—Å–µ –∫–ª—é—á–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ GitHub Secrets"
          echo "=========================================="

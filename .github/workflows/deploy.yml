name: üöÄ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: '–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'
  NODE_OPTIONS: '--max-old-space-size=4096'

jobs:
  validate-secrets:
    name: üîê –í–∞–ª–∏–¥–∞—Ü–∏—è Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.validate.outputs.valid }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub Secrets
        id: validate
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è GitHub Secrets..."
          
          SECRETS_VALID=true
          MISSING_SECRETS=""
          
          for secret in FIREBASE_API_KEY FIREBASE_AUTH_DOMAIN FIREBASE_DATABASE_URL FIREBASE_PROJECT_ID FIREBASE_STORAGE_BUCKET FIREBASE_MESSAGING_SENDER_ID FIREBASE_APP_ID FIREBASE_MEASUREMENT_ID; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $secret"
              SECRETS_VALID=false
              MISSING_SECRETS="$MISSING_SECRETS $secret"
            else
              echo "‚úÖ $secret: –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            fi
          done
          
          if [ "$SECRETS_VALID" = false ]; then
            echo "::error::–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Secrets:$MISSING_SECRETS"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "üéâ –í—Å–µ Secrets –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          echo "valid=true" >> $GITHUB_OUTPUT

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.secrets_valid == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js
        id: generate
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–±–ª–æ–Ω
          if [ ! -f "firebase-config.js.template" ]; then
            echo "::error::–®–∞–±–ª–æ–Ω firebase-config.js.template –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω
          TEMPLATE=$(cat firebase-config.js.template)
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          CONFIG="${TEMPLATE//\{\{FIREBASE_API_KEY\}\}/$FIREBASE_API_KEY}"
          CONFIG="${CONFIG//\{\{FIREBASE_AUTH_DOMAIN\}\}/$FIREBASE_AUTH_DOMAIN}"
          CONFIG="${CONFIG//\{\{FIREBASE_DATABASE_URL\}\}/$FIREBASE_DATABASE_URL}"
          CONFIG="${CONFIG//\{\{FIREBASE_PROJECT_ID\}\}/$FIREBASE_PROJECT_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_STORAGE_BUCKET\}\}/$FIREBASE_STORAGE_BUCKET}"
          CONFIG="${CONFIG//\{\{FIREBASE_MESSAGING_SENDER_ID\}\}/$FIREBASE_MESSAGING_SENDER_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_APP_ID\}\}/$FIREBASE_APP_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_MEASUREMENT_ID\}\}/$FIREBASE_MEASUREMENT_ID}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –∑–∞–º–µ–Ω—ã –ø—Ä–æ—à–ª–∏
          if echo "$CONFIG" | grep -q "{{"; then
            echo "::error::–í –∫–æ–Ω—Ñ–∏–≥–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã:"
            echo "$CONFIG" | grep -n "{{"
            exit 1
          fi
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
          echo "$CONFIG" > firebase-config.js
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
          if [ ! -f "firebase-config.js" ]; then
            echo "::error::–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å firebase-config.js"
            exit 1
          fi
          
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
          
      - name: üìÑ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll
        run: |
          echo "üìÑ –°–æ–∑–¥–∞—é .nojekyll –¥–ª—è GitHub Pages..."
          touch .nojekyll
          
      - name: üèóÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
        uses: actions/configure-pages@v5
        
      - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
        run: |
          echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
          echo ""
          echo "üåê –°–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
          echo "   https://askhat707.github.io/trading-data/"

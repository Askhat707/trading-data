name: Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create firebase-config.js
        run: |
          mkdir -p _site
          cat > _site/firebase-config.js << 'FIREBASE_CONFIG'
          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          if (typeof window !== 'undefined') {
            window.firebaseConfig = firebaseConfig;
          }
          console.log('Firebase config loaded');
          FIREBASE_CONFIG
          
          echo "firebase-config.js created"
          ls -lh _site/firebase-config.js

      - name: Copy project files
        run: |
          cp index.html _site/
          cp service-worker.js _site/
          cp firebase-config.js.template _site/
          cp -r js _site/
          cp -r css _site/
          cp -r scripts _site/
          
          echo "Files copied to _site"
          ls -la _site/ | head -20

      - name: Verify files
        run: |
          echo "Checking firebase-config.js..."
          if [ -f "_site/firebase-config.js" ]; then
            echo "✓ firebase-config.js exists"
            wc -l _site/firebase-config.js
          else
            echo "✗ firebase-config.js not found"
            exit 1
          fi
          
          echo "Checking index.html..."
          [ -f "_site/index.html" ] && echo "✓ index.html exists" || echo "✗ index.html not found"
          
          echo "Checking js folder..."
          [ -d "_site/js" ] && echo "✓ js folder exists" || echo "✗ js folder not found"

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'
          retention-days: 30

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

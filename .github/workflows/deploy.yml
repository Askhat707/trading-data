name: üöÄ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: '–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥'
        required: false
        default: 'false'

# –î–∞—ë–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  validate-secrets:
    name: üîê –í–∞–ª–∏–¥–∞—Ü–∏—è Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.validate.outputs.valid }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub Secrets
        id: validate
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è GitHub Secrets..."
          
          SECRETS_VALID=true
          MISSING_SECRETS=""
          
          for secret in FIREBASE_API_KEY FIREBASE_AUTH_DOMAIN FIREBASE_DATABASE_URL FIREBASE_PROJECT_ID FIREBASE_STORAGE_BUCKET FIREBASE_MESSAGING_SENDER_ID FIREBASE_APP_ID FIREBASE_MEASUREMENT_ID; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $secret"
              SECRETS_VALID=false
              MISSING_SECRETS="$MISSING_SECRETS $secret"
            else
              echo "‚úÖ $secret: –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            fi
          done
          
          if [ "$SECRETS_VALID" = false ]; then
            echo "::error::–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Secrets:$MISSING_SECRETS"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "üéâ –í—Å–µ Secrets –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          echo "valid=true" >> $GITHUB_OUTPUT

  generate-config:
    name: ‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.secrets_valid == 'true'
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: üì¶ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ —Å –ø–æ–º–æ—â—å—é Node
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js –∏–∑ —à–∞–±–ª–æ–Ω–∞..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
          if [ ! -f "scripts/generate-config.js" ]; then
            echo "üìù –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏..."
            cat > generate-config-simple.js << 'EOF'
            const fs = require('fs');
            
            const template = `// ====================================================
            // üî• FIREBASE CONFIG - GENERATED FROM GITHUB SECRETS
            // ‚ö†Ô∏è –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ GitHub Actions
            // ====================================================
            
            console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
            
            const firebaseConfig = {
              apiKey: "${process.env.FIREBASE_API_KEY}",
              authDomain: "${process.env.FIREBASE_AUTH_DOMAIN}",
              databaseURL: "${process.env.FIREBASE_DATABASE_URL}",
              projectId: "${process.env.FIREBASE_PROJECT_ID}",
              storageBucket: "${process.env.FIREBASE_STORAGE_BUCKET}",
              messagingSenderId: "${process.env.FIREBASE_MESSAGING_SENDER_ID}",
              appId: "${process.env.FIREBASE_APP_ID}",
              measurementId: "${process.env.FIREBASE_MEASUREMENT_ID}"
            };
            
            console.group('üìä Firebase Configuration:');
            console.log('‚úÖ –ü—Ä–æ–µ–∫—Ç:', firebaseConfig.projectId);
            console.log('‚úÖ Database:', firebaseConfig.databaseURL);
            console.log('‚úÖ Auth Domain:', firebaseConfig.authDomain);
            console.groupEnd();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            if (typeof window !== 'undefined') {
              window.firebaseConfig = firebaseConfig;
              console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ window.firebaseConfig');
            }
            
            console.log('‚úÖ FIREBASE CONFIG READY\\n');`;
            
            fs.writeFileSync('firebase-config.js', template);
            console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω');
            EOF
            
            node generate-config-simple.js
          else
            node scripts/generate-config.js
          fi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."
          if [ -f "firebase-config.js" ]; then
            echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
            head -20 firebase-config.js
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi

  build-and-deploy:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    needs: generate-config
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ firebase-config.js..."
          
          # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω
          TEMPLATE=$(cat firebase-config.js.template)
          
          # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          CONFIG="${TEMPLATE//\{\{FIREBASE_API_KEY\}\}/$FIREBASE_API_KEY}"
          CONFIG="${CONFIG//\{\{FIREBASE_AUTH_DOMAIN\}\}/$FIREBASE_AUTH_DOMAIN}"
          CONFIG="${CONFIG//\{\{FIREBASE_DATABASE_URL\}\}/$FIREBASE_DATABASE_URL}"
          CONFIG="${CONFIG//\{\{FIREBASE_PROJECT_ID\}\}/$FIREBASE_PROJECT_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_STORAGE_BUCKET\}\}/$FIREBASE_STORAGE_BUCKET}"
          CONFIG="${CONFIG//\{\{FIREBASE_MESSAGING_SENDER_ID\}\}/$FIREBASE_MESSAGING_SENDER_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_APP_ID\}\}/$FIREBASE_APP_ID}"
          CONFIG="${CONFIG//\{\{FIREBASE_MEASUREMENT_ID\}\}/$FIREBASE_MEASUREMENT_ID}"
          
          echo "$CONFIG" > firebase-config.js
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞:"
          echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < firebase-config.js) —Å—Ç—Ä–æ–∫"
          
          if grep -q "{{" firebase-config.js; then
            echo "‚ùå –í —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã!"
            exit 1
          fi
          
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω"
          
      - name: üìÑ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll
        run: |
          echo "üìÑ –°–æ–∑–¥–∞—é .nojekyll –¥–ª—è GitHub Pages..."
          touch .nojekyll
          
      - name: üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:"
          ls -la
          echo ""
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
          find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -20
          
      - name: üèóÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-pages-artifact@v2
        with:
          path: .
          
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3

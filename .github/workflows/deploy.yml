name: üöÄ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  validate:
    name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.check-secrets.outputs.valid }}
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
        id: check-secrets
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ GitHub Secrets..."
          
          # –°–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
          required_secrets=(
            "FIREBASE_API_KEY"
            "FIREBASE_AUTH_DOMAIN"
            "FIREBASE_DATABASE_URL"
            "FIREBASE_PROJECT_ID"
            "FIREBASE_STORAGE_BUCKET"
            "FIREBASE_MESSAGING_SENDER_ID"
            "FIREBASE_APP_ID"
            "FIREBASE_MEASUREMENT_ID"
          )
          
          missing_secrets=""
          for secret in "${required_secrets[@]}"; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $secret"
              missing_secrets="$missing_secrets $secret"
            else
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—É—Å—Ç–æ–µ –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
              secret_value="${!secret}"
              if [[ "$secret_value" == "***" || -z "$secret_value" ]]; then
                echo "‚ùå –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: $secret"
                missing_secrets="$missing_secrets $secret"
              else
                echo "‚úÖ $secret: OK"
              fi
            fi
          done
          
          if [ -n "$missing_secrets" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::error::–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–∫—Ä–µ—Ç—ã:$missing_secrets"
            exit 1
          else
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          fi

  build:
    name: ‚öôÔ∏è Build & Generate Config
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.secrets_valid == 'true'
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üìã –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
          find . -name "*.js" -o -name "*.yml" -o -name "*.template" | sort
          echo ""
          echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–±–ª–æ–Ω:"
          if [ -f "firebase-config.js.template" ]; then
            echo "‚úÖ –®–∞–±–ª–æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            head -5 firebase-config.js.template
          else
            echo "‚ùå –®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            find . -name "*.template"
          fi

      - name: üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js –∏–∑ Secrets
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥–∞..."
          echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ scripts/:"
          ls -la scripts/
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
          node scripts/generate-config.js
          
          echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          echo ""
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
          if [ -f "firebase-config.js" ]; then
            echo "‚úÖ –§–∞–π–ª firebase-config.js —Å–æ–∑–¥–∞–Ω"
            echo "–†–∞–∑–º–µ—Ä: $(wc -c < firebase-config.js) –±–∞–π—Ç"
            echo ""
            echo "üîç –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞:"
            head -10 firebase-config.js
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤:"
            if grep -q "{{" firebase-config.js; then
              echo "‚ùå –í —Ñ–∞–π–ª–µ –µ—Å—Ç—å –Ω–µ–∑–∞–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã!"
              grep -n "{{" firebase-config.js
              exit 1
            else
              echo "‚úÖ –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–º–µ–Ω–µ–Ω—ã"
            fi
          else
            echo "‚ùå –§–ê–ô–õ firebase-config.js –ù–ï –°–û–ó–î–ê–ù!"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
            ls -la
            exit 1
          fi

      - name: üìÑ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll
        run: touch .nojekyll

      - name: üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üìÅ –§–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è:"
          ls -la
          echo ""
          echo "üìÑ –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          ls -la firebase-config.js firebase-config.js.template index.html
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥:"
          if [ -f "firebase-config.js" ]; then
            echo "‚úÖ firebase-config.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: $(head -1 firebase-config.js)"
          else
            echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: firebase-config.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
            exit 1
          fi

      - name: üì¶ –£–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          retention-days: 1

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üöÄ –î–µ–ø–ª–æ–π
        id: deployment
        uses: actions/deploy-pages@v4

name: ðŸš€ Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    env:
      FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Validate Firebase Secrets
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Firebase Secrets..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· bash-Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
          echo "âœ… FIREBASE_API_KEY: $(echo $FIREBASE_API_KEY | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_AUTH_DOMAIN: $(echo $FIREBASE_AUTH_DOMAIN | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_DATABASE_URL: $(echo $FIREBASE_DATABASE_URL | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_PROJECT_ID: $(echo $FIREBASE_PROJECT_ID | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_STORAGE_BUCKET: $(echo $FIREBASE_STORAGE_BUCKET | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_MESSAGING_SENDER_ID: $(echo $FIREBASE_MESSAGING_SENDER_ID | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_APP_ID: $(echo $FIREBASE_APP_ID | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          echo "âœ… FIREBASE_MEASUREMENT_ID: $(echo $FIREBASE_MEASUREMENT_ID | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ
          if [ -z "${FIREBASE_API_KEY}" ]; then
            echo "âŒ FIREBASE_API_KEY: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_AUTH_DOMAIN}" ]; then
            echo "âŒ FIREBASE_AUTH_DOMAIN: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_DATABASE_URL}" ]; then
            echo "âŒ FIREBASE_DATABASE_URL: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_PROJECT_ID}" ]; then
            echo "âŒ FIREBASE_PROJECT_ID: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_STORAGE_BUCKET}" ]; then
            echo "âŒ FIREBASE_STORAGE_BUCKET: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_MESSAGING_SENDER_ID}" ]; then
            echo "âŒ FIREBASE_MESSAGING_SENDER_ID: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_APP_ID}" ]; then
            echo "âŒ FIREBASE_APP_ID: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          if [ -z "${FIREBASE_MEASUREMENT_ID}" ]; then
            echo "âŒ FIREBASE_MEASUREMENT_ID: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          
          echo "âœ… Ð’Ð¡Ð• Ð¡Ð•ÐšÐ Ð•Ð¢Ð« ÐŸÐ Ð˜Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð®Ð¢ Ð˜ Ð—ÐÐŸÐžÐ›ÐÐ•ÐÐ«"

      - name: ðŸ”§ Generate Firebase Config
        run: |
          echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ firebase-config.js..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          cat > firebase-config.js << 'CONFIG'
          // ====================================================
          // ðŸ”¥ FIREBASE CONFIG - GENERATED FROM GITHUB SECRETS
          // ====================================================
          
          console.log('ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...');
          
          const firebaseConfig = {
            apiKey: "$FIREBASE_API_KEY",
            authDomain: "$FIREBASE_AUTH_DOMAIN",
            databaseURL: "$FIREBASE_DATABASE_URL",
            projectId: "$FIREBASE_PROJECT_ID",
            storageBucket: "$FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "$FIREBASE_MESSAGING_SENDER_ID",
            appId: "$FIREBASE_APP_ID",
            measurementId: "$FIREBASE_MEASUREMENT_ID"
          };
          
          console.group('ðŸ“Š Firebase Configuration:');
          console.log('âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
          console.log('âœ… Auth Domain:', firebaseConfig.authDomain);
          console.log('âœ… Database:', firebaseConfig.databaseURL);
          console.groupEnd();
          
          window.firebaseConfig = firebaseConfig;
          console.log('âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² window.firebaseConfig');
          
          if (typeof module !== 'undefined' && module.exports) {
            module.exports = firebaseConfig;
          }
          CONFIG
          
          # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»Ðµ
          envsubst < firebase-config.js > firebase-config-temp.js
          mv firebase-config-temp.js firebase-config.js
          
          echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¾Ð·Ð´Ð°Ð½"
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°:"
          head -15 firebase-config.js
          echo "..."
          tail -5 firebase-config.js

      - name: ðŸ”§ Install envsubst (if needed)
        run: |
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° envsubst..."
          sudo apt-get update
          sudo apt-get install -y gettext-base

      - name: ðŸ“„ Create GitHub Pages Files
        run: |
          echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          touch .nojekyll
          
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          Sitemap: https://askhat707.github.io/trading-data/sitemap.xml
          EOF

      - name: ðŸ“ Verify Build Structure
        run: |
          echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ð°:"
          ls -la
          echo ""
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          test -f "index.html" && echo "âœ… index.html Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" || echo "âŒ index.html Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          test -f "firebase-config.js" && echo "âœ… firebase-config.js Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" || echo "âŒ firebase-config.js Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          echo ""
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ firebase-config.js (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº):"
          head -5 firebase-config.js
          echo ""
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ API Key Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ:"
          if grep -q 'apiKey: "AIza' firebase-config.js; then
            echo "âœ… API Key Ð½Ð°Ð¹Ð´ÐµÐ½ (Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ AIza)"
          else
            echo "âš ï¸  API Key Ð¸Ð¼ÐµÐµÑ‚ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚"
            grep 'apiKey:' firebase-config.js | head -1
          fi

      - name: ðŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

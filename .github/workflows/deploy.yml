name: ðŸš€ Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Validate Firebase Secrets
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Firebase Secrets..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ 8 Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          REQUIRED_SECRETS=(
            "FIREBASE_API_KEY"
            "FIREBASE_AUTH_DOMAIN"
            "FIREBASE_DATABASE_URL"
            "FIREBASE_PROJECT_ID"
            "FIREBASE_STORAGE_BUCKET"
            "FIREBASE_MESSAGING_SENDER_ID"
            "FIREBASE_APP_ID"
            "FIREBASE_MEASUREMENT_ID"
          )
          
          HAS_ERROR=false
          for SECRET in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!SECRET}" ]; then
              echo "âŒ $SECRET: ÐžÐ¢Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð•Ð¢ Ð² GitHub Secrets"
              HAS_ERROR=true
            else
              # ÐœÐ°ÑÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
              VALUE="${!SECRET}"
              MASKED="${VALUE:0:6}...${VALUE: -6}"
              echo "âœ… $SECRET: Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ($MASKED)"
            fi
          done
          
          if [ "$HAS_ERROR" = true ]; then
            echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Firebase Secrets"
            echo "ðŸ“‹ Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²ÑÐµ 8 ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð² GitHub: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi

      - name: ðŸ”§ Generate Firebase Config
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ firebase-config.js..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð¸Ð· Secrets
          cat > firebase-config.js << 'EOF'
          // ====================================================
          // ðŸ”¥ FIREBASE CONFIG - GENERATED FROM GITHUB SECRETS
          // âš ï¸ Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ GitHub Actions
          // ====================================================
          
          console.log('ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...');
          
          const firebaseConfig = {
            apiKey: "$FIREBASE_API_KEY",
            authDomain: "$FIREBASE_AUTH_DOMAIN",
            databaseURL: "$FIREBASE_DATABASE_URL",
            projectId: "$FIREBASE_PROJECT_ID",
            storageBucket: "$FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "$FIREBASE_MESSAGING_SENDER_ID",
            appId: "$FIREBASE_APP_ID",
            measurementId: "$FIREBASE_MEASUREMENT_ID"
          };
          
          // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
          if (!firebaseConfig.apiKey || firebaseConfig.apiKey === '') {
            console.error('âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: FIREBASE_API_KEY Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚');
          }
          
          if (!firebaseConfig.projectId || firebaseConfig.projectId === '') {
            console.error('âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: FIREBASE_PROJECT_ID Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚');
          }
          
          console.group('ðŸ“Š Firebase Configuration:');
          console.log('âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
          console.log('âœ… Auth Domain:', firebaseConfig.authDomain);
          console.log('âœ… Database:', firebaseConfig.databaseURL);
          console.groupEnd();
          
          // Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²
          if (typeof window !== 'undefined') {
            window.firebaseConfig = firebaseConfig;
            console.log('âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² window.firebaseConfig');
          }
          
          console.log('âœ… FIREBASE CONFIG READY\n');
          
          // CommonJS ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
          if (typeof module !== 'undefined' && module.exports) {
            module.exports = firebaseConfig;
          }
          EOF
          
          echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¾Ð·Ð´Ð°Ð½"
          echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°:" $(wc -c < firebase-config.js) "Ð±Ð°Ð¹Ñ‚"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Secrets ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸ÑÑŒ
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…..."
          if grep -q '\$FIREBASE_' firebase-config.js; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ Ð²ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸ÑÑŒ!"
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ 500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ñ„Ð°Ð¹Ð»Ð°:"
            head -c 500 firebase-config.js
            exit 1
          fi
          
          if grep -q 'apiKey: ""' firebase-config.js; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: API Key Ð¿ÑƒÑÑ‚Ð¾Ð¹!"
            exit 1
          fi
          
          echo "âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"

      - name: ðŸ“„ Create GitHub Pages Files
        run: |
          echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Jekyll
          touch .nojekyll
          
          # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: CNAME Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð³Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°
          # echo "askhat707.github.io" > CNAME
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ robots.txt
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          Sitemap: https://askhat707.github.io/trading-data/sitemap.xml
          EOF
          
          echo "âœ… Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"

      - name: ðŸ“ Verify Build Structure
        run: |
          echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          echo "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
          echo ""
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:"
          ls -la
          echo ""
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          test -f "index.html" && echo "âœ… index.html" || echo "âŒ index.html"
          test -f "firebase-config.js" && echo "âœ… firebase-config.js" || echo "âŒ firebase-config.js"
          test -d "js" && echo "âœ… js directory" || echo "âŒ js directory"
          test -d "css" && echo "âœ… css directory" || echo "âŒ css directory"
          
          echo ""
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° firebase-config.js:"
          if [ -f "firebase-config.js" ]; then
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº:"
            head -5 firebase-config.js
            echo ""
            echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð»Ð¸ API Key?"
            if grep -q 'apiKey: "AIza' firebase-config.js; then
              echo "âœ… API Key Ð½Ð°Ð¹Ð´ÐµÐ½ (Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ AIza)"
            else
              echo "âš ï¸  API Key Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ"
              grep 'apiKey:' firebase-config.js | head -1
            fi
          fi

      - name: ðŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

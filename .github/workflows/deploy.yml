name: üöÄ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: '–ü–µ—Ä–µ–≥–µ–Ω –∫–æ–Ω—Ñ–∏–≥–∞'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  validate-and-deploy:
    name: üîê –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –î–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîê –ì–ï–ù–ï–†–ê–¶–ò–Ø firebase-config.js –ò–ó –°–ï–ö–†–ï–¢–û–í
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üöÄ –ì–ï–ù–ï–†–ò–†–£–Æ firebase-config.js..."
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã
          SECRETS_OK=true
          for secret in FIREBASE_API_KEY FIREBASE_AUTH_DOMAIN FIREBASE_DATABASE_URL FIREBASE_PROJECT_ID FIREBASE_STORAGE_BUCKET FIREBASE_MESSAGING_SENDER_ID FIREBASE_APP_ID FIREBASE_MEASUREMENT_ID; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ä–µ—Ç: $secret"
              SECRETS_OK=false
            else
              MASKED="${!secret:0:8}...${!secret: -4}"
              echo "‚úÖ $secret: $MASKED"
            fi
          done
          
          if [ "$SECRETS_OK" = false ]; then
            echo ""
            echo "‚ùå –ù–ï –í–°–ï –°–ï–ö–†–ï–¢–´ –ù–ê–ô–î–ï–ù–´!"
            echo "üìã –î–æ–±–∞–≤—å—Ç–µ –≤—Å–µ 8 —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ –í–°–ï –°–ï–ö–†–ï–¢–´ –ü–†–ò–°–£–¢–°–¢–í–£–Æ–¢"
          echo ""
          
          # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω
          cat firebase-config.js.template > firebase-config.js.tmp
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
          sed -i "s|{{FIREBASE_API_KEY}}|${FIREBASE_API_KEY}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_AUTH_DOMAIN}}|${FIREBASE_AUTH_DOMAIN}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_DATABASE_URL}}|${FIREBASE_DATABASE_URL}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_PROJECT_ID}}|${FIREBASE_PROJECT_ID}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_STORAGE_BUCKET}}|${FIREBASE_STORAGE_BUCKET}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_MESSAGING_SENDER_ID}}|${FIREBASE_MESSAGING_SENDER_ID}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_APP_ID}}|${FIREBASE_APP_ID}|g" firebase-config.js.tmp
          sed -i "s|{{FIREBASE_MEASUREMENT_ID}}|${FIREBASE_MEASUREMENT_ID}|g" firebase-config.js.tmp
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º
          mv firebase-config.js.tmp firebase-config.js
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          if [ ! -f "firebase-config.js" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: firebase-config.js –Ω–µ —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi
          
          if grep -q "{{" firebase-config.js; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –í —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã!"
            grep "{{" firebase-config.js
            exit 1
          fi
          
          echo "‚úÖ firebase-config.js —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
          echo ""
          echo "üìã –ü–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫:"
          head -n 20 firebase-config.js
          echo ""
          echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"

      - name: üìù –ö–æ–º–º–∏—Ç –∫–æ–Ω—Ñ–∏–≥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        run: |
          echo "üìù –ö–æ–º–º–∏—Ç—é firebase-config.js..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ñ–∞–π–ª
          if git diff --quiet firebase-config.js; then
            echo "‚ÑπÔ∏è  –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç"
          else
            echo "üìù –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è, –∫–æ–º–º–∏—Ç—é..."
            git add firebase-config.js
            git commit -m "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js –∏–∑ GitHub Secrets [skip ci]"
            git push
            echo "‚úÖ –§–∞–π–ª –∑–∞–∫–æ–º–º–∏—á–µ–Ω –∏ –∑–∞–ø—É—à–µ–Ω"
          fi

      - name: üßπ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll
        run: |
          echo "üìÑ –°–æ–∑–¥–∞—é .nojekyll –¥–ª—è GitHub Pages..."
          touch .nojekyll
          git add .nojekyll
          git commit -m "Add .nojekyll for GitHub Pages [skip ci]" || echo "‚ÑπÔ∏è  –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          git push || echo "‚ÑπÔ∏è  –ù–µ—á–µ–≥–æ –ø—É—à–∏—Ç—å"

      - name: üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
        uses: actions/configure-pages@v3

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–∞ Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: üöÄ –î–ï–ü–õ–û–ô –ù–ê GITHUB PAGES
        id: deployment
        uses: actions/deploy-pages@v2

      - name: ‚úÖ –£–°–ü–ï–•!
        run: |
          echo ""
          echo "=========================================="
          echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
          echo "=========================================="
          echo ""
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω:"
          echo "   https://askhat707.github.io/trading-data/"
          echo ""
          echo "üìù –õ–æ–≥–∏ GitHub Actions:"
          echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞:"
          echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
          echo "   2. –ù–∞–∂–º–∏—Ç–µ F12 –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏"
          echo "   3. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ‚úÖ"
          echo ""
          echo "üìä Firebase –∫–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω:"
          ls -lah firebase-config.js
          echo ""
          echo "=========================================="

name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ============ Ð¡ÐÐœÐ«Ð™ Ð’ÐÐ–ÐÐ«Ð™ Ð¨ÐÐ“! ============
      - name: ðŸ” Generate firebase-config.js from GitHub Secrets
        run: |
          mkdir -p _site
          
          cat > _site/firebase-config.js << 'FIREBASE_EOF'
          // ðŸ”¥ FIREBASE CONFIG - ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð¡Ð“Ð•ÐÐ•Ð Ð˜Ð ÐžÐ’ÐÐ Ð˜Ð— GITHUB SECRETS
          // âš ï¸ ÐšÐ›Ð®Ð§Ð˜ ÐÐ˜ÐšÐžÐ“Ð”Ð ÐÐ• Ð¡ÐžÐ¥Ð ÐÐÐ¯Ð®Ð¢Ð¡Ð¯ Ð’ Ð Ð•ÐŸÐžÐ—Ð˜Ð¢ÐžÐ Ð˜Ð˜!
          // âš ï¸ ÐšÐ›Ð®Ð§Ð˜ Ð—ÐÐ©Ð˜Ð©Ð•ÐÐ« GITHUB SECRETS!
          
          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ ÐºÐ»ÑŽÑ‡Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹
          if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('secrets.')) {
              throw new Error('âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: GitHub Secrets Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Settings â†’ Secrets');
          }
          
          // Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
          if (typeof window !== 'undefined') {
              window.firebaseConfig = firebaseConfig;
          }
          
          console.log('âœ… Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¸Ð· GitHub Secrets');
          console.log('ðŸ” ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
          FIREBASE_EOF
          
          echo "âœ… firebase-config.js ÑÐ¾Ð·Ð´Ð°Ð½"
          wc -l _site/firebase-config.js
      
      # ============ ÐšÐžÐŸÐ˜Ð Ð£Ð•Ðœ ÐžÐ¡Ð¢ÐÐ›Ð¬ÐÐ«Ð• Ð¤ÐÐ™Ð›Ð« ============
      - name: ðŸ“¦ Copy project files
        run: |
          cp -r index.html _site/
          cp -r service-worker.js _site/
          cp -r css/ _site/
          cp -r js/ _site/
          cp -r scripts/ _site/
          
          echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          ls -la _site/ | head -20
      
      # ============ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡ÐšÐžÐŸÐ˜Ð ÐžÐ’ÐÐÐÐ«Ð¥ Ð¤ÐÐ™Ð›ÐžÐ’ ============
      - name: âœ… Verify generated files
        run: |
          echo "=== Ð¤ÐÐ™Ð›Ð« Ð’ _site ===" 
          ls -la _site/
          
          echo ""
          echo "=== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ firebase-config.js ===" 
          head -20 _site/firebase-config.js
          
          echo ""
          echo "=== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ index.html ===" 
          grep -c "firebase-config.js" _site/index.html && echo "âœ… firebase-config.js Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½" || echo "âŒ firebase-config.js ÐÐ• Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½"
      
      # ============ Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ GITHUB PAGES ============
      - name: ðŸŒ Setup Pages
        uses: actions/configure-pages@v3
      
      # ============ Ð—ÐÐ“Ð Ð£Ð—ÐšÐ ÐÐ Ð¢Ð•Ð¤ÐÐšÐ¢Ð ============
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'
          retention-days: 30
      
      # ============ Ð”Ð•ÐŸÐ›ÐžÐ™ ÐÐ GITHUB PAGES ============
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      # ============ Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§ÐÐ¢ ============
      - name: ðŸ“‹ Deployment Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           âœ… DEPLOYMENT Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚: https://askhat707.github.io/trading-data/"
          echo ""
          echo "ðŸ” Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬:"
          echo "  âœ… ÐšÐ»ÑŽÑ‡Ð¸ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð¢ÐžÐ›Ð¬ÐšÐž Ð² GitHub Secrets"
          echo "  âœ… ÐšÐ»ÑŽÑ‡Ð¸ ÐÐ• Ð²Ð¸Ð´Ð½Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸"
          echo "  âœ… firebase-config.js Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
          echo "  âœ… Ð¤Ð°Ð¹Ð» .gitignore Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ firebase-config.js"
          echo ""
          echo "âš ï¸ Ð•Ð¡Ð›Ð˜ ÐžÐ¨Ð˜Ð‘ÐšÐ:"
          echo "  1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Settings â†’ Secrets and variables â†’ Actions"
          echo "  2. Ð’ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:"
          echo "     - FIREBASE_API_KEY"
          echo "     - FIREBASE_AUTH_DOMAIN"
          echo "     - FIREBASE_DATABASE_URL"
          echo "     - FIREBASE_PROJECT_ID"
          echo "     - FIREBASE_STORAGE_BUCKET"
          echo "     - FIREBASE_MESSAGING_SENDER_ID"
          echo "     - FIREBASE_APP_ID"
          echo "     - FIREBASE_MEASUREMENT_ID"
          echo ""

name: ðŸš€ Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    env:
      FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Validate Firebase Secrets
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Firebase Secrets..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹
          if [ -z "$FIREBASE_API_KEY" ]; then
            echo "âŒ FIREBASE_API_KEY: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          
          if [ -z "$FIREBASE_PROJECT_ID" ]; then
            echo "âŒ FIREBASE_PROJECT_ID: ÐŸÐ£Ð¡Ð¢ÐžÐ™"
            exit 1
          fi
          
          echo "âœ… FIREBASE_API_KEY: $(echo $FIREBASE_API_KEY | cut -c1-10)..."
          echo "âœ… FIREBASE_PROJECT_ID: $FIREBASE_PROJECT_ID"
          echo "âœ… Ð’Ð¡Ð• Ð¡Ð•ÐšÐ Ð•Ð¢Ð« ÐŸÐ Ð˜Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð®Ð¢"

      - name: ðŸ”§ Generate Firebase Config
        run: |
          echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ firebase-config.js..."
          
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ cat Ñ Ð´Ð²Ð¾Ð¹Ð½Ñ‹Ð¼Ð¸ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
          cat > firebase-config.js << 'EOF'
          // ============================================
          // ðŸ”¥ FIREBASE CONFIG - AUTOGENERATED
          // ============================================
          
          console.log('ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...');
          
          const firebaseConfig = {
            apiKey: "$FIREBASE_API_KEY",
            authDomain: "$FIREBASE_AUTH_DOMAIN",
            databaseURL: "$FIREBASE_DATABASE_URL",
            projectId: "$FIREBASE_PROJECT_ID",
            storageBucket: "$FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "$FIREBASE_MESSAGING_SENDER_ID",
            appId: "$FIREBASE_APP_ID",
            measurementId: "$FIREBASE_MEASUREMENT_ID"
          };
          
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½
          if (!firebaseConfig.apiKey) {
            console.error('âŒ Firebase API Key not found!');
            throw new Error('Invalid Firebase Configuration');
          }
          
          console.group('âœ… Firebase Configuration:');
          console.log('Project:', firebaseConfig.projectId);
          console.log('Auth Domain:', firebaseConfig.authDomain);
          console.log('Database URL:', firebaseConfig.databaseURL);
          console.groupEnd();
          
          window.firebaseConfig = firebaseConfig;
          
          if (typeof module !== 'undefined' && module.exports) {
            module.exports = firebaseConfig;
          }
          EOF
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
          sed -i "s|\$FIREBASE_API_KEY|${FIREBASE_API_KEY}|g" firebase-config.js
          sed -i "s|\$FIREBASE_AUTH_DOMAIN|${FIREBASE_AUTH_DOMAIN}|g" firebase-config.js
          sed -i "s|\$FIREBASE_DATABASE_URL|${FIREBASE_DATABASE_URL}|g" firebase-config.js
          sed -i "s|\$FIREBASE_PROJECT_ID|${FIREBASE_PROJECT_ID}|g" firebase-config.js
          sed -i "s|\$FIREBASE_STORAGE_BUCKET|${FIREBASE_STORAGE_BUCKET}|g" firebase-config.js
          sed -i "s|\$FIREBASE_MESSAGING_SENDER_ID|${FIREBASE_MESSAGING_SENDER_ID}|g" firebase-config.js
          sed -i "s|\$FIREBASE_APP_ID|${FIREBASE_APP_ID}|g" firebase-config.js
          sed -i "s|\$FIREBASE_MEASUREMENT_ID|${FIREBASE_MEASUREMENT_ID}|g" firebase-config.js
          
          echo "âœ… Config ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
          echo ""
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°:"
          head -20 firebase-config.js
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ API Key Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÐµÐ½
          if grep -q "apiKey: \"AIza" firebase-config.js; then
            echo ""
            echo "âœ… API Key Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÐµÐ½ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
          else
            echo ""
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: API Key Ð½Ðµ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÐµÐ½!"
            cat firebase-config.js | grep apiKey
            exit 1
          fi

      - name: ðŸ“„ Create Support Files
        run: |
          echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          touch .nojekyll
          echo "âœ… .nojekyll ÑÐ¾Ð·Ð´Ð°Ð½"

      - name: ðŸ“ Verify Structure
        run: |
          echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          echo ""
          
          echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ñ€ÐµÐ¿Ð¾:"
          ls -la | grep -E "^-" | awk '{print "  " $9}'
          
          echo ""
          echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          test -f "index.html" && echo "  âœ… index.html" || echo "  âŒ index.html Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!"
          test -f "firebase-config.js" && echo "  âœ… firebase-config.js" || echo "  âŒ firebase-config.js Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!"
          test -f ".nojekyll" && echo "  âœ… .nojekyll" || echo "  âŒ .nojekyll Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚!"
          
          echo ""
          echo "âœ… Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ firebase-config.js (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 15 ÑÑ‚Ñ€Ð¾Ðº):"
          head -15 firebase-config.js

      - name: ðŸ“¦ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

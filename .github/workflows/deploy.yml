name: ðŸš€ Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'ÐŸÐµÑ€ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³'
        required: false
        default: 'false'

# Ð”Ð°Ñ‘Ð¼ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  validate-secrets:
    name: ðŸ” Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.validate.outputs.valid }}
    
    steps:
      - name: ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4
        
      - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° GitHub Secrets
        id: validate
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ GitHub Secrets..."
          
          SECRETS_VALID=true
          MISSING_SECRETS=""
          
          for secret in FIREBASE_API_KEY FIREBASE_AUTH_DOMAIN FIREBASE_DATABASE_URL FIREBASE_PROJECT_ID FIREBASE_STORAGE_BUCKET FIREBASE_MESSAGING_SENDER_ID FIREBASE_APP_ID FIREBASE_MEASUREMENT_ID; do
            if [ -z "${!secret}" ]; then
              echo "âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚: $secret"
              SECRETS_VALID=false
              MISSING_SECRETS="$MISSING_SECRETS $secret"
            else
              echo "âœ… $secret: Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
            fi
          done
          
          if [ "$SECRETS_VALID" = false ]; then
            echo "::error::ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Secrets:$MISSING_SECRETS"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ðŸŽ‰ Ð’ÑÐµ Secrets Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚"
          echo "valid=true" >> $GITHUB_OUTPUT

  generate-config:
    name: âš™ï¸ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.secrets_valid == 'true'
    
    steps:
      - name: ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "ðŸš€ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ firebase-config.js..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
          if [ -f "scripts/generate-config.js" ]; then
            echo "ðŸ“ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚..."
            node scripts/generate-config.js
          else
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ..."
            cat > firebase-config.js << 'EOF'
            // ====================================================
            // ðŸ”¥ FIREBASE CONFIG - GENERATED FROM GITHUB SECRETS
            // âš ï¸ Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ GitHub Actions
            // ====================================================
            
            console.log('ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...');
            
            const firebaseConfig = {
              apiKey: "$FIREBASE_API_KEY",
              authDomain: "$FIREBASE_AUTH_DOMAIN",
              databaseURL: "$FIREBASE_DATABASE_URL",
              projectId: "$FIREBASE_PROJECT_ID",
              storageBucket: "$FIREBASE_STORAGE_BUCKET",
              messagingSenderId: "$FIREBASE_MESSAGING_SENDER_ID",
              appId: "$FIREBASE_APP_ID",
              measurementId: "$FIREBASE_MEASUREMENT_ID"
            };
            
            console.group('ðŸ“Š Firebase Configuration:');
            console.log('âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
            console.log('âœ… Database:', firebaseConfig.databaseURL);
            console.log('âœ… Auth Domain:', firebaseConfig.authDomain);
            console.groupEnd();
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
            if (typeof window !== 'undefined') {
              window.firebaseConfig = firebaseConfig;
              console.log('âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² window.firebaseConfig');
            }
            
            console.log('âœ… FIREBASE CONFIG READY\n');
            EOF
          fi
          
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚..."
          if [ -f "firebase-config.js" ]; then
            echo "âœ… Ð¤Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            echo "ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº):"
            head -10 firebase-config.js
          else
            echo "âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½!"
            exit 1
          fi

  build-and-deploy:
    name: ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹
    runs-on: ubuntu-latest
    needs: generate-config
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð° (Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸)
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ firebase-config.js..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
          cat > firebase-config.js << 'EOF'
          // ====================================================
          // ðŸ”¥ FIREBASE CONFIG - GENERATED FROM GITHUB SECRETS
          // âš ï¸ Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ GitHub Actions
          // ====================================================
          
          console.log('ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...');
          
          const firebaseConfig = {
            apiKey: "$FIREBASE_API_KEY",
            authDomain: "$FIREBASE_AUTH_DOMAIN",
            databaseURL: "$FIREBASE_DATABASE_URL",
            projectId: "$FIREBASE_PROJECT_ID",
            storageBucket: "$FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "$FIREBASE_MESSAGING_SENDER_ID",
            appId: "$FIREBASE_APP_ID",
            measurementId: "$FIREBASE_MEASUREMENT_ID"
          };
          
          console.group('ðŸ“Š Firebase Configuration:');
          console.log('âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
          console.log('âœ… Database:', firebaseConfig.databaseURL);
          console.log('âœ… Auth Domain:', firebaseConfig.authDomain);
          console.groupEnd();
          
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
          if (typeof window !== 'undefined') {
            window.firebaseConfig = firebaseConfig;
            console.log('âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² window.firebaseConfig');
          }
          
          console.log('âœ… FIREBASE CONFIG READY\n');
          EOF
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
          if [ ! -f "firebase-config.js" ]; then
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: firebase-config.js Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½!"
            exit 1
          fi
          
          echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¾Ð·Ð´Ð°Ð½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ..."
          if grep -q "{{" firebase-config.js; then
            echo "âŒ Ð’ Ñ„Ð°Ð¹Ð»Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹!"
            exit 1
          fi
          
          if grep -q "FIREBASE_" firebase-config.js; then
            echo "âŒ Ð’ Ñ„Ð°Ð¹Ð»Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ FIREBASE_!"
            exit 1
          fi
          
          echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½"
          
      - name: ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .nojekyll
        run: |
          echo "ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°ÑŽ .nojekyll Ð´Ð»Ñ GitHub Pages..."
          touch .nojekyll
          
      - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
        run: |
          echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          ls -la
          echo ""
          echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹:"
          find . -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" \) | head -20
          
      - name: ðŸ—ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°
        uses: actions/upload-pages-artifact@v2
        with:
          path: .
          
      - name: ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3

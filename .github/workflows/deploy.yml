name: Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate firebase-config.js
        run: |
          # –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p build
          
          # –°–æ–∑–¥–∞–µ–º firebase-config.js –∏–∑ —à–∞–±–ª–æ–Ω–∞ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–µ–∫—Ä–µ—Ç–æ–≤
          cat > build/firebase-config.js << 'EOF'
          // üî• AUTO-GENERATED FIREBASE CONFIG - DO NOT COMMIT
          // Generated by GitHub Actions from Secrets
          
          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          
          // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          if (typeof window !== 'undefined') {
            window.firebaseConfig = firebaseConfig;
          }
          
          console.log('‚úÖ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ GitHub Secrets');
          console.log('   –ü—Ä–æ–µ–∫—Ç:', firebaseConfig.projectId);
          EOF
          
          echo "‚úÖ firebase-config.js —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ build/"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
          if [ -f "build/firebase-config.js" ]; then
            echo "üìÑ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < build/firebase-config.js) —Å—Ç—Ä–æ–∫"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã (–Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç FIREBASE_)
            if grep -q "FIREBASE_" build/firebase-config.js; then
              echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã!"
              echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ FIREBASE_* Secrets –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ GitHub"
            else
              echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
            fi
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: firebase-config.js –Ω–µ —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi

      - name: Copy all necessary files to build
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º HTML —Ñ–∞–π–ª—ã
          cp index.html build/
          
          # –ö–æ–ø–∏—Ä—É–µ–º service worker
          cp service-worker.js build/
          
          # –ö–æ–ø–∏—Ä—É–µ–º CSS —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          mkdir -p build/css
          mkdir -p build/css/components
          mkdir -p build/css/pages
          
          cp css/base.css build/css/
          cp css/components/cards.css build/css/components/
          cp css/components/modal.css build/css/components/
          cp css/components/table.css build/css/components/
          cp css/pages/terminal.css build/css/pages/
          
          # –ö–æ–ø–∏—Ä—É–µ–º JS —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          mkdir -p build/js
          mkdir -p build/js/modules
          mkdir -p build/js/services
          mkdir -p build/js/utils
          
          cp js/*.js build/js/ 2>/dev/null || true
          cp js/modules/*.js build/js/modules/ 2>/dev/null || true
          cp js/services/*.js build/js/services/ 2>/dev/null || true
          cp js/utils/*.js build/js/utils/ 2>/dev/null || true
          
          # –°–æ–∑–¥–∞–µ–º .nojekyll –¥–ª—è GitHub Pages
          touch build/.nojekyll
          
          # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ build/:"
          find build -type f -name "*.js" -o -name "*.css" -o -name "*.html" | sort

      - name: Verify critical files
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
          
          CRITICAL_FILES=(
            "build/index.html"
            "build/firebase-config.js"
            "build/service-worker.js"
            "build/js/app.js"
            "build/js/modules/auth.js"
            "build/css/base.css"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå $file - –ù–ï –ù–ê–ô–î–ï–ù!"
              exit 1
            fi
          done
          
          echo "‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ"

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: 'build'
          retention-days: 30

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

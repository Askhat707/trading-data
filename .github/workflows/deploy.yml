name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Generate Firebase Config from Secrets
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
          cat > generate-config.js << 'EOF'
          const fs = require('fs');
          
          // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ğ· GitHub Secrets
          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          
          const configContent = `// ğŸ”¥ FIREBASE CONFIG - AUTO GENERATED FROM GITHUB SECRETS
          const firebaseConfig = ${JSON.stringify(firebaseConfig, null, 2)};
          
          // Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
          window.firebaseConfig = firebaseConfig;
          
          // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
          if (typeof firebase !== 'undefined') {
            try {
              if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('âœ… Firebase Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°');
              }
            } catch (error) {
              console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Firebase:', error);
            }
          }`;
          
          fs.writeFileSync('firebase-config.js', configContent);
          console.log('âœ… Firebase config generated from GitHub Secrets');
          EOF
          
          node generate-config.js
      
      - name: Verify Generated Config
        run: |
          echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° ==="
          if [ -f "firebase-config.js" ]; then
            echo "âœ… firebase-config.js ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
            head -20 firebase-config.js
          else
            echo "âŒ firebase-config.js Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!"
            exit 1
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Build and copy files
        run: |
          mkdir -p _site
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ’Ğ¡Ğ• Ñ„Ğ°Ğ¹Ğ»Ñ‹
          cp -r index.html _site/
          cp -r firebase-config.js _site/
          cp -r service-worker.js _site/
          cp -r css/ _site/
          cp -r js/ _site/
          
          echo "=== Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ² _site ==="
          ls -la _site/
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Deployment Status
        run: |
          echo "âœ… Ğ”Ğµployment ÑƒÑĞ¿ĞµÑˆĞµĞ½!"
          echo "ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:"
          echo "   https://askhat707.github.io/trading-data/"

name: Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - List files before build
        run: |
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:"
          find . -type f -name "*.js" -o -name "*.html" -o -name "*.css" | grep -v node_modules | sort
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ firebase-config.js.template:"
          ls -la firebase-config.js.template || echo "‚ùå firebase-config.js.template –Ω–µ –Ω–∞–π–¥–µ–Ω!"

      - name: Create firebase-config.js from template
        run: |
          echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ firebase-config.js –∏–∑ —à–∞–±–ª–æ–Ω–∞..."
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p build
          
          # –ß–∏—Ç–∞–µ–º —à–∞–±–ª–æ–Ω –∏ –∑–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã
          if [ -f "firebase-config.js.template" ]; then
            echo "‚úÖ –®–∞–±–ª–æ–Ω –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            
            # –°–æ–∑–¥–∞–µ–º firebase-config.js —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–µ–∫—Ä–µ—Ç–æ–≤
            sed \
              -e "s|FIREBASE_API_KEY|${{ secrets.FIREBASE_API_KEY }}|g" \
              -e "s|FIREBASE_AUTH_DOMAIN|${{ secrets.FIREBASE_AUTH_DOMAIN }}|g" \
              -e "s|FIREBASE_DATABASE_URL|${{ secrets.FIREBASE_DATABASE_URL }}|g" \
              -e "s|FIREBASE_PROJECT_ID|${{ secrets.FIREBASE_PROJECT_ID }}|g" \
              -e "s|FIREBASE_STORAGE_BUCKET|${{ secrets.FIREBASE_STORAGE_BUCKET }}|g" \
              -e "s|FIREBASE_MESSAGING_SENDER_ID|${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}|g" \
              -e "s|FIREBASE_APP_ID|${{ secrets.FIREBASE_APP_ID }}|g" \
              -e "s|FIREBASE_MEASUREMENT_ID|${{ secrets.FIREBASE_MEASUREMENT_ID }}|g" \
              firebase-config.js.template > build/firebase-config.js
              
            echo "‚úÖ firebase-config.js —Å–æ–∑–¥–∞–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
            if [ -s "build/firebase-config.js" ]; then
              echo "üìÑ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < build/firebase-config.js) —Å—Ç—Ä–æ–∫"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã
              if grep -q "FIREBASE_" build/firebase-config.js; then
                echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã (–æ—Å—Ç–∞–ª–∏—Å—å FIREBASE_)"
                echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Secrets:"
                echo "   - FIREBASE_API_KEY"
                echo "   - FIREBASE_AUTH_DOMAIN"
                echo "   - FIREBASE_DATABASE_URL"
                echo "   - FIREBASE_PROJECT_ID"
                echo "   - FIREBASE_STORAGE_BUCKET"
                echo "   - FIREBASE_MESSAGING_SENDER_ID"
                echo "   - FIREBASE_APP_ID"
                echo "   - FIREBASE_MEASUREMENT_ID"
              else
                echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã"
              fi
            else
              echo "‚ùå –û–®–ò–ë–ö–ê: firebase-config.js –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω"
              exit 1
            fi
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: firebase-config.js.template –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

      - name: Copy HTML files
        run: |
          echo "üìÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Ñ–∞–π–ª–æ–≤..."
          
          # –ö–æ–ø–∏—Ä—É–µ–º index.html –≤ build
          cp index.html build/
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø—É—Ç—å –∫ firebase-config.js –Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π
          sed -i 's|src="firebase-config.js"|src="./firebase-config.js"|g' build/index.html
          
          # –ö–æ–ø–∏—Ä—É–µ–º service worker
          cp service-worker.js build/
          
          echo "‚úÖ HTML —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

      - name: Copy CSS files
        run: |
          echo "üé® –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ CSS —Ñ–∞–π–ª–æ–≤..."
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π CSS
          mkdir -p build/css
          mkdir -p build/css/components
          mkdir -p build/css/pages
          
          # –ö–æ–ø–∏—Ä—É–µ–º CSS —Ñ–∞–π–ª—ã
          cp css/base.css build/css/
          cp css/components/cards.css build/css/components/
          cp css/components/modal.css build/css/components/
          cp css/components/table.css build/css/components/
          cp css/pages/terminal.css build/css/pages/
          
          echo "‚úÖ CSS —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

      - name: Copy JavaScript files
        run: |
          echo "üìú –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ JavaScript —Ñ–∞–π–ª–æ–≤..."
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π JS
          mkdir -p build/js
          mkdir -p build/js/modules
          mkdir -p build/js/services
          mkdir -p build/js/utils
          
          # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ JS —Ñ–∞–π–ª—ã
          cp js/app.js build/js/
          cp js/constants.js build/js/
          
          # –ö–æ–ø–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏
          cp js/modules/auth.js build/js/modules/
          cp js/modules/charts.js build/js/modules/
          cp js/modules/firebase.js build/js/modules/
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
          cp js/services/api.js build/js/services/
          cp js/services/cache.js build/js/services/
          
          # –ö–æ–ø–∏—Ä—É–µ–º —É—Ç–∏–ª–∏—Ç—ã
          cp js/utils/helpers.js build/js/utils/
          
          echo "‚úÖ JavaScript —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

      - name: Create .nojekyll file
        run: |
          echo "üö´ –°–æ–∑–¥–∞–Ω–∏–µ .nojekyll —Ñ–∞–π–ª–∞..."
          touch build/.nojekyll
          echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω"

      - name: Debug - List build directory
        run: |
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          find build -type f | sort
          echo ""
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã:"
          ls -la build/firebase-config.js || echo "‚ùå firebase-config.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ build!"
          ls -la build/index.html || echo "‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ build!"
          ls -la build/js/modules/auth.js || echo "‚ùå auth.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ build!"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ firebase-config.js (–ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏)
          echo ""
          echo "üìÑ –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ firebase-config.js:"
          head -5 build/firebase-config.js

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: 'build/'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

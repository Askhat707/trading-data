name: Deploy Trading Data Terminal

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ============ Ð“Ð•ÐÐ•Ð Ð˜Ð Ð£Ð•Ðœ firebase-config.js ============
      - name: ðŸ” Generate firebase-config.js from GitHub Secrets
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÑÐ°Ð¹Ñ‚Ð°
          mkdir -p _site
          
          # Ð¡ÐÐœÐ«Ð™ Ð’ÐÐ–ÐÐ«Ð™ Ð¨ÐÐ“ - Ð¡ÐžÐ—Ð”ÐÐÐœ ÐšÐžÐÐ¤Ð˜Ð“
          cat > _site/firebase-config.js << 'EOF'


const firebaseConfig = {
  apiKey: "${{ secrets.FIREBASE_API_KEY }}",
  authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
  databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
  projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
  storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
  messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
  appId: "${{ secrets.FIREBASE_APP_ID }}",
  measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
};

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ ÐºÐ»ÑŽÑ‡Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹
if (!firebaseConfig.apiKey) {
  console.error('âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: GitHub Secrets Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹!');
  throw new Error('Firebase API Key is missing');
}

// Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
if (typeof window !== 'undefined') {
  window.firebaseConfig = firebaseConfig;
}

console.log('âœ… Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°');
console.log('ðŸ”¥ ÐŸÑ€Ð¾ÐµÐºÑ‚:', firebaseConfig.projectId);
EOF

          echo "âœ… firebase-config.js ÑÐ¾Ð·Ð´Ð°Ð½!"
          echo ""
          echo "=== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¤ÐÐ™Ð›Ð ==="
          ls -lh _site/firebase-config.js
          echo ""
          echo "=== ÐŸÐ•Ð Ð’Ð«Ð• 10 Ð¡Ð¢Ð ÐžÐš ==="
          head -10 _site/firebase-config.js

      # ============ ÐšÐžÐŸÐ˜Ð Ð£Ð•Ðœ ÐžÐ¡Ð¢ÐÐ›Ð¬ÐÐ«Ð• Ð¤ÐÐ™Ð›Ð« ============
      - name: ðŸ“¦ Copy all project files
        run: |
          echo "ðŸ“‚ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹..."
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -v index.html _site/ || true
          cp -v service-worker.js _site/ || true
          cp -v firebase-config.js.template _site/ || true
          cp -v README.md _site/ || true
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÐ¸
          cp -rv css _site/ || true
          cp -rv js _site/ || true
          cp -rv scripts _site/ || true
          
          echo ""
          echo "âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹!"
          echo ""
          echo "=== Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð _site ==="
          find _site -type f -name "*.js" -o -name "*.html" -o -name "*.json" | head -20

      # ============ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¤ÐÐ™Ð›ÐžÐ’ ============
      - name: âœ… Verify generated files
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¤ÐÐ™Ð›ÐžÐ’                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ firebase-config.js
          echo "ðŸ”¥ firebase-config.js:"
          if [ -f "_site/firebase-config.js" ]; then
            echo "  âœ… ÐÐÐ™Ð”Ð•Ð"
            echo "  ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€: $(wc -c < _site/firebase-config.js) Ð±Ð°Ð¹Ñ‚"
            echo "  ðŸ“ Ð¡Ñ‚Ñ€Ð¾Ðº: $(wc -l < _site/firebase-config.js)"
            echo ""
            echo "  ðŸ” Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ:"
            grep -c "apiKey" _site/firebase-config.js && echo "    âœ… apiKey"
            grep -c "authDomain" _site/firebase-config.js && echo "    âœ… authDomain"
            grep -c "projectId" _site/firebase-config.js && echo "    âœ… projectId"
            grep -c "databaseURL" _site/firebase-config.js && echo "    âœ… databaseURL"
          else
            echo "  âŒ ÐÐ• ÐÐÐ™Ð”Ð•Ð!"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“„ index.html:"
          if [ -f "_site/index.html" ]; then
            echo "  âœ… ÐÐÐ™Ð”Ð•Ð"
            if grep -q "firebase-config.js" _site/index.html; then
              echo "  âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ firebase-config.js"
            else
              echo "  âŒ firebase-config.js ÐÐ• Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½!"
            fi
          else
            echo "  âŒ ÐÐ• ÐÐÐ™Ð”Ð•Ð!"
          fi
          
          echo ""
          echo "ðŸ“ ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
          [ -f "_site/service-worker.js" ] && echo "  âœ… service-worker.js" || echo "  âš ï¸ service-worker.js"
          [ -d "_site/js" ] && echo "  âœ… js/ Ð¿Ð°Ð¿ÐºÐ°" || echo "  âš ï¸ js/ Ð¿Ð°Ð¿ÐºÐ°"
          [ -d "_site/css" ] && echo "  âœ… css/ Ð¿Ð°Ð¿ÐºÐ°" || echo "  âš ï¸ css/ Ð¿Ð°Ð¿ÐºÐ°"
          
          echo ""

      # ============ GITHUB PAGES ============
      - name: ðŸŒ Setup Pages
        uses: actions/configure-pages@v3
      
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'
          retention-days: 30

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      # ============ Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§ÐÐ¢ ============
      - name: ðŸ“‹ Deployment Success Report
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        âœ… DEPLOYMENT Ð£Ð¡ÐŸÐ•Ð¨Ð•Ð!                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:"
          echo "   https://askhat707.github.io/trading-data/"
          echo ""
          echo "ðŸ” Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬:"
          echo "  âœ… firebase-config.js ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· GitHub Secrets"
          echo "  âœ… ÐšÐ»ÑŽÑ‡Ð¸ ÐÐ• Ð²Ð¸Ð´Ð½Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸"
          echo "  âœ… ÐšÐ»ÑŽÑ‡Ð¸ ÐÐ• Ð²Ð¸Ð´Ð½Ñ‹ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²"
          echo "  âœ… Security Rules Ð·Ð°Ñ‰Ð¸Ñ‰Ð°ÑŽÑ‚ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
          echo ""
          echo "ðŸ“Š ÐŸÐ ÐÐ’Ð˜Ð›Ð Ð”ÐžÐ¡Ð¢Ð£ÐŸÐ (Security Rules):"
          echo "  âœ… Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ"
          echo "  âœ… ÐÐ¸ÐºÑ‚Ð¾ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ (read-only)"
          echo "  âœ… TRIAL: dte_0, dte_1"
          echo "  âœ… PREMIUM: dte_2-9"
          echo ""
          echo "â±ï¸ Deploy Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ Ð² $(date)"
          echo ""

      # ============ ÐžÐ¢Ð§ÐÐ¢ ÐžÐ‘ ÐžÐ¨Ð˜Ð‘ÐšÐ• ============
      - name: âŒ Deployment Error Report
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âŒ DEPLOYMENT ÐžÐ¨Ð˜Ð‘ÐšÐ!                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ” ÐŸÐ ÐžÐ’Ð•Ð Ð¬:"
          echo ""
          echo "1ï¸âƒ£ GitHub Secrets ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹?"
          echo "   Settings â†’ Secrets and variables â†’ Actions"
          echo ""
          echo "   Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑÑ‚Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:"
          echo "   - FIREBASE_API_KEY"
          echo "   - FIREBASE_AUTH_DOMAIN"
          echo "   - FIREBASE_DATABASE_URL"
          echo "   - FIREBASE_PROJECT_ID"
          echo "   - FIREBASE_STORAGE_BUCKET"
          echo "   - FIREBASE_MESSAGING_SENDER_ID"
          echo "   - FIREBASE_APP_ID"
          echo "   - FIREBASE_MEASUREMENT_ID"
          echo ""
          echo "2ï¸âƒ£ .github/workflows/deploy.yml ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾?"
          echo "   ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ YAML Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹"
          echo ""
          echo "3ï¸âƒ£ Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸ Ð»Ð¾Ð³Ð¸ GitHub Actions"
          echo "   Actions â†’ [Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº] â†’ [job]"
          echo ""

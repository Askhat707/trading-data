name: Deploy Trading Data Terminal

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Ubuntu
jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
          
      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm ci || npm install
          
      - name: üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: |
          echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è firebase-config.js –∏–∑ GitHub Secrets..."
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
          cat > firebase-config.js << 'EOF'
          // üî• FIREBASE CONFIG - AUTO GENERATED FROM GITHUB SECRETS
          // ‚ö†Ô∏è –°–û–ó–î–ê–ù–û –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ü–†–ò –î–ï–ü–õ–û–ï - –ù–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨!
          
          console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ GitHub Secrets...');
          
          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            databaseURL: "${{ secrets.FIREBASE_DATABASE_URL }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          
          console.log('üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase:');
          console.log('  - –ü—Ä–æ–µ–∫—Ç:', firebaseConfig.projectId);
          console.log('  - Database URL:', firebaseConfig.databaseURL);
          console.log('  - Auth Domain:', firebaseConfig.authDomain);
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –∑–∞–º–µ–Ω–µ–Ω—ã
          const hasPlaceholders = Object.values(firebaseConfig).some(value => 
            typeof value === 'string' && (value.includes('${{') || value.includes('secrets.'))
          );
          
          if (hasPlaceholders) {
            console.error('‚ùå –û–®–ò–ë–ö–ê: –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ!');
            console.error('   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Secrets –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏');
          } else {
            console.log('‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–º–µ–Ω–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏');
            console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
          }
          
          // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          if (typeof window !== 'undefined') {
              window.firebaseConfig = firebaseConfig;
              console.log('‚úÖ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ window.firebaseConfig');
          }
          EOF
          
          echo "‚úÖ firebase-config.js —Å–æ–∑–¥–∞–Ω"
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):"
          head -n 20 firebase-config.js
          
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          if [ ! -f "firebase-config.js" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: firebase-config.js –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–º–µ–Ω–µ–Ω—ã
          if grep -q "\${{" firebase-config.js; then
            echo "‚ùå –û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GitHub Actions!"
            grep -n "\${{" firebase-config.js
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          if grep -q "FIREBASE_" firebase-config.js; then
            echo "‚ùå –û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–ª–∏—Å—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ FIREBASE_*"
            grep -n "FIREBASE_" firebase-config.js
            exit 1
          fi
          
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
          
      - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
        run: |
          echo "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫..."
          mkdir -p css/components css/pages js/modules js/services js/utils scripts
          
      - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          REQUIRED_FILES=(
            "index.html"
            "css/base.css"
            "css/components/modal.css"
            "css/components/cards.css"
            "css/components/table.css"
            "css/pages/terminal.css"
            "js/app.js"
            "js/constants.js"
            "js/modules/auth.js"
            "js/modules/firebase.js"
            "js/modules/charts.js"
            "js/services/api.js"
            "js/services/cache.js"
            "js/utils/helpers.js"
            "service-worker.js"
            "firebase-config.js"
          )
          
          missing_files=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª: $file"
              missing_files=$((missing_files + 1))
            else
              echo "‚úÖ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: $file"
            fi
          done
          
          if [ $missing_files -gt 0 ]; then
            echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç $missing_files —Ñ–∞–π–ª–æ–≤!"
            exit 1
          else
            echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ"
          fi
          
      - name: üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages
        uses: actions/configure-pages@v3
        
      - name: üì¶ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          echo "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
          # –°–æ–∑–¥–∞–µ–º .nojekyll —Ñ–∞–π–ª –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Jekyll
          touch .nojekyll
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–ø–ª–æ—è
          echo "Deployed: $(date)" > DEPLOY_TIME.txt
          
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'  # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
        
      - name: üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://askhat707.github.io/trading-data/"
          echo "üïê –í—Ä–µ–º—è –¥–µ–ø–ª–æ—è: $(date)"
          
      - name: üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
          fi
